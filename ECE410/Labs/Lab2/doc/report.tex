\documentclass[12pt]{article}

\usepackage[margin=1.9cm, letterpaper]{geometry}
\usepackage[utf8]{inputenc}
\usepackage{indentfirst}
\usepackage{tikz}
\usepackage{float}
\usepackage{subcaption}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage{siunitx}
\usepackage{pdfpages}
\usepackage{minted}
\usepackage{fontspec}
\usepackage{hyperref}
\usepackage{pdflscape}
\usepackage[style=ieee]{biblatex}

\setmainfont{Noto Serif}
\setsansfont{Segoe UI}
\setmonofont{Consolas}

% \usemintedstyle{monokai}
% \definecolor{codeBg}{HTML}{282822}
% \setminted{bgcolor=codeBg}

\usetikzlibrary{arrows,automata,positioning}

\begin{document}
\begin{titlepage}
  \begin{center}
    \vspace*{1cm}

    \textbf{LAB 2}

    \vspace{0.5cm}

    Finite State Machines in VHDL

    \vspace{1.5cm}

    \textbf{Michael Kwok (1548454)}

    \vfill

    ECE 410 -- Advanced Digital Logic Design\\
    Department of Electrical and Computer Engineering\\
    University of Alberta\\
    October 20, 2021

  \end{center}
\end{titlepage}

\tableofcontents

\pagebreak

\section{Abstract}

This lab had the implementation of a sequence detector and vending machine using a Mealy machine.
For both designs, multiple VHDL processes were used as a method to improve modularity in the code, and to allow for the
synthesis tool to recognize the State Machine. An external seven-segment display was used in the 2nd part of the lab,
which required knowledge about the pinouts of the Zybo board and the connections of the seven-segment PMOD module.

\section{Design}

\subsection{Sequence Detector}
\begin{figure}[h]
  \centering
  \begin{tikzpicture}[shorten >=1pt,node distance=2cm,auto]
    \tikzstyle{every state}=[fill={rgb:black,1;white,10}]

    \node[state,initial] (s_0) {$s_0$};
    \node[state] (s_1) [below right of=s_0] {$s_1$};
    \node[state] (s_2) [below of=s_1] {$s_2$};
    \node[state] (s_3) [left of=s_2] {$s_3$};
    \node[state] (s_4) [above left of=s_3] {$s_4$};

    \path[->]
    (s_0) edge [loop] node {$0/0$} ()
    (s_0) edge [bend left] node {$1/0$} (s_1)
    (s_1) edge node {$1/0$} (s_2)
    (s_1) edge node {$0/0$} (s_0)
    (s_2) edge [loop right] node {$1/0$} ()
    (s_2) edge node {$0/0$} (s_3)
    (s_3) edge node {$0/0$} (s_0)
    (s_3) edge node {$1/0$} (s_4)
    (s_4) edge [bend left] node {$1/1$} (s_2)
    (s_4) edge node {$0/0$} (s_0);
  \end{tikzpicture}
  \caption{State diagram for sequence detector}
  \label{fig:state-diagram}
\end{figure}

The first part of the lab required the design of a finite state machine to detect the sequence \verb|11011| with overlap detection. A Mealy machine was chosen for the design of this part, as it is likely to be easier than a Moore machine.

The design of the sequence detector started with the construction of a state diagram (Figure \ref{fig:state-diagram}), indicating all the present states, expected input and output combinations, and next states.
This was then implemented as a two-process behavioural model in VHDL, with one clocked process for state changes and synchronous resets and the second process handling input, state changes and output behaviour. This was done to improve the readability of the code and to more closely model what the digital logic circuit implementing the behaviour would be structured physically.

\subsection{Vending Machine}

For the second part of the lab, a ``vending machine'' was to be designed. The system accepted inputs indicating the requested item and the amount of money inserted. The system also had outputs indicating the amount of money currently inside the machine, the item dispensed, and the change returned. This part was also implemented with a Mealy machine as it reduces the number of states required.

The system was required to stop accepting money as soon as the selected item can be afforded and dispense the item directly. This was implemented in the system by moving along to the state that indicated what the balance would be after paying for the item.

For the seven-segment display output, a lookup table-like pure function was made, to reduce the presence of ``magic strings'' in the implementation code.

A state diagram and state change table is provided in the Appendix.

\section{Testing \& Simulation}

Both systems were initially tested with the XSim (Vivado) simulator before being implemented to hardware and then tested physically.

\begin{figure}[h]
  \includegraphics[width=\linewidth]{waveform-sequence.png}
  \caption{Sequence Detector Waveform}
  \label{fig:waveform-sequence}
\end{figure}

The testbench for the sequence detector was set up to push in inputs from an instance of \verb|std_logic_vector| into the detector. The test vector was filled in with instances of correct sequences, incorrect sequences and overlapping sequences to test every possible path for the state machine.
The test sequence selected was \verb|01101101110110001101011|, which is expected to output \verb|1| three times and \verb|0| at every other clock cycle. Figure \ref{fig:waveform-sequence} confirms this.

\begin{figure}[h]
  \includegraphics[width=\linewidth]{waveform-vending.png}
  \caption{Vending Machine Waveform}
  \label{fig:waveform-vending}
\end{figure}

For the vending machine, typical inputs were used as the test stimulus. The waveform for this part is shown in Figure \ref{fig:waveform-vending}. As shown, the outputs are properly clocked, changing states every rising edge. The first two testcases were for dispensing the soft drink. One was a single clock of \$2 coins, the other was two clocks of \$1 coins. For the granola bar, a testcase of two \$3 dollar coins and another testcase of \$3 and \$2 coints were used. Every expected outcome was asserted in the testbench to ensure correct operation.

\section{Conclusion}

In this lab, two uses of a Mealy machine was demonstrated: One for a sequence detector, and one for a vending machine. This was all implemented with behavioural level sequential VHDL. The utility of using multiple processes as part structuring a design, and planning out the design before coding was emphasized.

The use of a seven segment display was also demonstrated, along with learning to read the schematics to get the constraint files working.

% \section{References}
\pagebreak

\begin{landscape}
  \section{Appendix}
  \subsection{Vending Machine State Diagram}
  \begin{center}
    \begin{tikzpicture}[shorten >=1pt,auto,node distance=3cm]
      \node[state,initial] (sum0) {$sum_0$};
      \node[state] (sum3) [right of=sum0] {$sum_3$};
      \node[state] (sum2) [right of=sum3] {$sum_2$};
      \node[state] (sum1) [right of=sum2] {$sum_1$};
      \node[state] (sum4) [right of=sum1] {$sum_4$};
      \node[state] (dispense) [right of=sum4] {$dispense$};
      \node[state] (sum5) [right of=dispense] {$sum_5$};
      \node[state] (sum6) [right of=sum5] {$sum_6$};

      \path[->]
      (sum0) edge [loop right] node {} ()
      (sum0) edge [bend left] node {} (sum3)
      (sum0) edge [bend left] node {} (sum2)
      (sum0) edge [bend left] node {} (sum1)
      (sum3) edge [loop right] node {} ()
      (sum3) edge [bend left] node {} (sum2)
      (sum3) edge [bend left] node {} (sum4)
      (sum3) edge [bend left] node {} (sum5)
      (sum3) edge [bend left] node {} (sum6)
      (sum2) edge [loop right] node {} ()
      (sum2) edge [bend left] node {} (sum4)
      (sum2) edge [bend left] node {} (dispense)
      (sum2) edge [bend left] node {} (sum5)
      (sum1) edge [loop right] node {} ()
      (sum1) edge [bend left] node {} (sum4)
      (sum4) edge [bend left] node {} (dispense)
      (sum5) edge [bend left] node {} (sum4)
      (sum6) edge [bend left] node {} (sum4)
      (dispense) edge [bend left] node {} (sum0)
      (sum4) edge [bend left] node {} (sum2)
      (sum1) edge [bend left] node {} (sum2)
      (sum1) edge [bend left] node {} (sum3)
      (sum2) edge [bend left] node {} (sum3);
    \end{tikzpicture}
  \end{center}
\end{landscape}

\begin{center}
  \begin{tabular}{c c c c}
    \toprule
    Start State & End State & Condition (Coins In)/(Item Sel) & Output (Change)/(Soda)/(Granola) \\
    \midrule
    $sum_0$     & $sum_0$   & 00/x                            & 00/0/0                           \\
    $sum_0$     & $sum_1$   & 01/x                            & 00/0/0                           \\
    $sum_0$     & $sum_2$   & 10/x                            & 00/0/0                           \\
    $sum_0$     & $sum_3$   & 11/x                            & 00/0/0                           \\
    $sum_1$     & $sum_1$   & 00/x                            & 00/0/0                           \\
    $sum_1$     & $sum_2$   & 01/x                            & 00/0/0                           \\
    $sum_1$     & $sum_3$   & 10/x                            & 00/0/0                           \\
    $sum_1$     & $sum_4$   & 11/x                            & 00/0/0                           \\
    $sum_2$     & $sum_2$   & 00/1                            & 00/0/0                           \\
    $sum_2$     & $sum_3$   & 01/1                            & 00/0/0                           \\
    $sum_2$     & $sum_4$   & 10/1                            & 00/0/0                           \\
    $sum_2$     & $sum_5$   & 11/1                            & 00/0/0                           \\
    $sum_2$     & Dispense  & xx/0                            & 00/0/0                           \\
    $sum_3$     & $sum_2$   & xx/0                            & 01/0/0                           \\
    $sum_3$     & $sum_3$   & 00/1                            & 00/0/0                           \\
    $sum_3$     & $sum_4$   & 01/1                            & 00/0/0                           \\
    $sum_3$     & $sum_5$   & 10/1                            & 00/0/0                           \\
    $sum_3$     & $sum_6$   & 11/1                            & 00/0/0                           \\
    $sum_4$     & $sum_2$   & xx/0                            & 10/0/0                           \\
    $sum_4$     & Dispense  & xx/1                            & 00/0/0                           \\
    $sum_5$     & $sum_4$   & xx/x                            & 01/0/0                           \\
    $sum_6$     & $sum_4$   & xx/x                            & 10/0/0                           \\
    Dispense    & $sum_0$   & xx/x                            & 00/Item Sel/!Item Sel            \\
    \bottomrule
  \end{tabular}
\end{center}
\pagebreak

\subsection{Top Level File}
\inputminted{vhdl}{../src/Lab2_top.vhd}

\pagebreak
\subsection{Clock Divider}
\inputminted{vhdl}{../src/ClockDivider.vhd}

\pagebreak
\subsection{Sequence Detector}
\inputminted{vhdl}{../src/SequenceDetector.vhd}

\pagebreak
\subsection{Vending Machine}
\inputminted{vhdl}{../src/VendingMachine.vhd}

\pagebreak
\subsection{Sequence Detector Testbench}
\inputminted{vhdl}{../test/SequenceDetector_tb.vhd}

\pagebreak
\subsection{Vending Machine Testbench}
\inputminted{vhdl}{../test/VendingMachine_tb.vhd}

\end{document}
